From cdc6f38e3e4a994df8c40c6f0b4b7db14da2dd35 Mon Sep 17 00:00:00 2001
From: Torne (Richard Coles) <torne@google.com>
Date: Tue, 03 Nov 2020 19:02:16 +0000
Subject: [PATCH] android: upstream missed manifest changes for Q/R.

On Q+ we disabled audio capture as we have no way to selectively disable
it for incognito tabs, but this was missed when upstreaming Q.

Chrome needs QUERY_ALL_PACKAGES permission on R+ to check for any
possible intent handler for URLs. This was added downstream but missed
while upstreaming R support; add it now.

Bug: 948282, 1042023
Change-Id: I4136beddcba0227ef6cfc2073f90d645151ce6bb
Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/2507575
Reviewed-by: David Trainor <dtrainor@chromium.org>
Reviewed-by: Theresa  <twellington@chromium.org>
Commit-Queue: Richard Coles <torne@chromium.org>
Cr-Commit-Position: refs/heads/master@{#823642}
---

diff --git a/chrome/android/expectations/monochrome_public_bundle.AndroidManifest.expected b/chrome/android/expectations/monochrome_public_bundle.AndroidManifest.expected
index 6f4d9f3..d9d8beb 100644
--- a/chrome/android/expectations/monochrome_public_bundle.AndroidManifest.expected
+++ b/chrome/android/expectations/monochrome_public_bundle.AndroidManifest.expected
@@ -38,6 +38,7 @@
   <uses-permission android:name="android.permission.MANAGE_ACCOUNTS"/>
   <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS"/>
   <uses-permission android:name="android.permission.NFC"/>
+  <uses-permission android:name="android.permission.QUERY_ALL_PACKAGES"/>
   <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
   <uses-permission android:name="android.permission.READ_SYNC_SETTINGS"/>
   <uses-permission android:name="android.permission.READ_SYNC_STATS"/>
@@ -64,6 +65,7 @@
   <uses-permission-sdk-23 android:name="android.permission.USE_FINGERPRINT"/>
   <uses-sdk android:minSdkVersion="24" android:targetSdkVersion="30"/>
   <application
+      android:allowAudioPlaybackCapture="false"
       android:allowBackup="false"
       android:extractNativeLibs="false"
       android:icon="@drawable/ic_launcher"
diff --git a/chrome/android/expectations/trichrome_chrome_bundle.AndroidManifest.expected b/chrome/android/expectations/trichrome_chrome_bundle.AndroidManifest.expected
index c2ce36754..ec2185e 100644
--- a/chrome/android/expectations/trichrome_chrome_bundle.AndroidManifest.expected
+++ b/chrome/android/expectations/trichrome_chrome_bundle.AndroidManifest.expected
@@ -38,6 +38,7 @@
   <uses-permission android:name="android.permission.MANAGE_ACCOUNTS"/>
   <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS"/>
   <uses-permission android:name="android.permission.NFC"/>
+  <uses-permission android:name="android.permission.QUERY_ALL_PACKAGES"/>
   <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
   <uses-permission android:name="android.permission.READ_SYNC_SETTINGS"/>
   <uses-permission android:name="android.permission.READ_SYNC_STATS"/>
@@ -64,6 +65,7 @@
   <uses-permission-sdk-23 android:name="android.permission.USE_FINGERPRINT"/>
   <uses-sdk android:minSdkVersion="29" android:targetSdkVersion="30"/>
   <application
+      android:allowAudioPlaybackCapture="false"
       android:allowBackup="false"
       android:extractNativeLibs="false"
       android:icon="@drawable/ic_launcher"
diff --git a/chrome/android/java/AndroidManifest.xml b/chrome/android/java/AndroidManifest.xml
index 2948f6a5..075d3ff 100644
--- a/chrome/android/java/AndroidManifest.xml
+++ b/chrome/android/java/AndroidManifest.xml
@@ -53,6 +53,7 @@
     <uses-permission android:name="android.permission.MANAGE_ACCOUNTS"/>
     <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS"/>
     <uses-permission android:name="android.permission.NFC"/>
+    <uses-permission android:name="android.permission.QUERY_ALL_PACKAGES" />
     <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
     <uses-permission android:name="android.permission.READ_SYNC_SETTINGS"/>
     <uses-permission android:name="android.permission.READ_SYNC_STATS"/>
@@ -176,6 +177,7 @@
         android:allowBackup="false"
         {% endif %}
         android:networkSecurityConfig="@xml/network_security_config"
+        android:allowAudioPlaybackCapture="false"
         {% block extra_application_attributes %}{% endblock %}>
 
       {% macro application_definitions() %}
